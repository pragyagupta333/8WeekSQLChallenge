SET search_path = data_bank;

SELECT * FROM REGIONS
SELECT * FROM CUSTOMER_NODES
SELECT * FROM CUSTOMER_TRANSACTIONS
ORDER BY 1
------------------------------------------------------ B. Customer Transactions ----------------------------------------------------------------------------

-- QUE 1 : What is the unique count and total amount for each transaction type?
-- ANS :

SELECT TXN_TYPE AS TRANSACTION_TYPE, COUNT(*) AS UNIQUE_COUNT, SUM(TXN_AMOUNT)
FROM CUSTOMER_TRANSACTIONS
GROUP BY 1

-- QUE 2 : What is the average total historical deposit counts and amounts for all customers?
-- ANS :

WITH COUNT_CTE AS (
	SELECT CUSTOMER_ID, COUNT(*) AS deposit_counts, SUM(TXN_AMOUNT) AS AMOUNT
	FROM CUSTOMER_TRANSACTIONS
	WHERE TXN_TYPE ILIKE 'DEPOSIT'
	GROUP BY CUSTOMER_ID
)
SELECT ROUND(AVG(deposit_counts),1) AS deposit_counts , ROUND(AVG(AMOUNT),1) AS AMOUNT
FROM COUNT_CTE


-- QUE 3 : For each month - how many Data Bank customers make more than 1 deposit and either 1 purchase or 1 withdrawal in a single month?
-- ANS :

WITH COUNT_CTE AS (
SELECT CUSTOMER_ID,TO_CHAR(TXN_DATE, 'MONTH') AS MONTH,
	SUM( CASE WHEN TXN_TYPE ILIKE 'DEPOSIT' THEN 1 ELSE 0 END ) AS DEPOSITS_COUNT,
	SUM( CASE WHEN TXN_TYPE ILIKE 'PURCHASE' THEN 1 ELSE 0 END ) AS PURCHASE_COUNT,
	SUM( CASE WHEN TXN_TYPE ILIKE 'WITHDRAWAL' THEN 1 ELSE 0 END ) AS WITHDRAWAL_COUNT	   		
FROM CUSTOMER_TRANSACTIONS
GROUP BY 1,2
)
SELECT MONTH,COUNT(C.CUSTOMER_ID) 
FROM COUNT_CTE C
WHERE DEPOSITS_COUNT > 1 AND (PURCHASE_COUNT = 1 OR WITHDRAWAL_COUNT = 1)
GROUP BY 1

-- QUE 4 : What is the closing balance for each customer at the end of the month?
-- ANS :

WITH MONTHLY_TRANSACTIONS_CTE AS (
	SELECT CUSTOMER_ID,
	EXTRACT('MONTH' FROM TXN_DATE) AS MONTH,
	TXN_DATE,TXN_TYPE,
		CASE WHEN TXN_TYPE ILIKE 'DEPOSIT' THEN TXN_AMOUNT 
			 ELSE -TXN_AMOUNT 
		END AS TXN_AMOUNT
	FROM CUSTOMER_TRANSACTIONS
	GROUP BY 1,2,3,4,5
	ORDER BY 1
)
,
MONTHLY_BALANCE_CTE AS (
	SELECT CUSTOMER_ID, MONTH, TXN_DATE,  TXN_TYPE, TXN_AMOUNT,
	SUM(TXN_AMOUNT) OVER(PARTITION BY CUSTOMER_ID ORDER BY TXN_DATE ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS BALANCE,
	--SUMS ALL ABOVE ROWS IN THAT PARTITION TILL CURRENT ROW
	ROW_NUMBER() OVER(PARTITION BY CUSTOMER_ID,MONTH ORDER BY TXN_DATE DESC ) AS RN
	FROM MONTHLY_TRANSACTIONS_CTE
)
SELECT CUSTOMER_ID,MONTH,BALANCE AS CLOSING_BALANCE
FROM MONTHLY_BALANCE_CTE 
WHERE RN=1



-- QUE 5 : What is the percentage of customers who increase their closing balance by more than 5%?
-- ANS :
WITH MONTHLY_TRANSACTIONS_CTE AS (
	
	SELECT CUSTOMER_ID,
	EXTRACT('MONTH' FROM TXN_DATE) AS MONTH,
	TXN_DATE,TXN_TYPE,
		CASE WHEN TXN_TYPE ILIKE 'DEPOSIT' THEN TXN_AMOUNT 
			 ELSE -TXN_AMOUNT 
		END AS TXN_AMOUNT
	FROM CUSTOMER_TRANSACTIONS
	GROUP BY 1,2,3,4,5
	ORDER BY 1
)
,
MONTHLY_BALANCE_CTE AS (
	
	SELECT CUSTOMER_ID, MONTH, TXN_DATE,  TXN_TYPE, TXN_AMOUNT,
	SUM(TXN_AMOUNT) OVER(PARTITION BY CUSTOMER_ID ORDER BY TXN_DATE ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS BALANCE,
	--SUMS ALL ABOVE ROWS IN THAT PARTITION TILL CURRENT ROW
	ROW_NUMBER() OVER(PARTITION BY CUSTOMER_ID,MONTH ORDER BY TXN_DATE DESC ) AS RN
	FROM MONTHLY_TRANSACTIONS_CTE
),
BALANCE_CTE AS (
	
	SELECT CUSTOMER_ID,MONTH,BALANCE AS CURRENT_BALANCE ,
	 LAG(BALANCE) OVER(PARTITION BY CUSTOMER_ID ORDER BY MONTH) AS PREV_BALANCE
	FROM MONTHLY_BALANCE_CTE 
	WHERE RN=1
),
PERCENTAGE_BALANCE_CTE AS (
	SELECT *,
	CASE WHEN CURRENT_BALANCE > PREV_BALANCE
		THEN (CURRENT_BALANCE - PREV_BALANCE)*100/CURRENT_BALANCE END AS PER_BALANCE
	FROM BALANCE_CTE
)
SELECT COUNT(CUSTOMER_ID)*100/(SELECT COUNT (DISTINCT CUSTOMER_ID) FROM CUSTOMER_TRANSACTIONS)::DECIMAL
FROM PERCENTAGE_BALANCE_CTE
WHERE PER_BALANCE>5