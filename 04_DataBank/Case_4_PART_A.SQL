SET search_path = data_bank;

SELECT * FROM REGIONS
SELECT * FROM CUSTOMER_NODES
SELECT * FROM CUSTOMER_TRANSACTIONS

SELECT CUSTOMER_ID,  NODE_ID, C.REGION_ID, REGION_NAME, START_DATE, END_DATE
FROM CUSTOMER_NODES C
JOIN REGIONS R ON C.REGION_ID = R.REGION_ID 


------------------------------------------------------ A. Customer Nodes Exploration ----------------------------------------------------------------------------

-- QUE 1 : How many unique nodes are there on the Data Bank system?
-- ANS : 

SELECT COUNT(DISTINCT NODE_ID)
FROM CUSTOMER_NODES


-- QUE 2 : What is the number of nodes per region?
-- ANS :

SELECT REGION_NAME,COUNT( DISTINCT NODE_ID) AS NODES_COUNT
FROM CUSTOMER_NODES C
JOIN REGIONS R ON C.REGION_ID = R.REGION_ID 
GROUP BY REGION_NAME

-- QUE 3 : How many customers are allocated to each region?
-- ANS : 

SELECT REGION_NAME,COUNT(DISTINCT CUSTOMER_ID) CUSTOMER_COUNT
FROM CUSTOMER_NODES C
JOIN REGIONS R ON C.REGION_ID = R.REGION_ID 
GROUP BY REGION_NAME


-- QUE 4 : How many days on average are customers reallocated to a different node?
-- ANS : 
-- COUNTING ONLY THOSE DAYS WHERE NODES ARE DIFFERNT

WITH DATE_CTE AS (
	SELECT CUSTOMER_ID,NODE_ID CURRENT_NODE, 
	LEAD(NODE_ID) OVER(PARTITION BY CUSTOMER_ID ORDER BY START_DATE) NEXT_NODE,
	START_DATE, END_DATE
	FROM CUSTOMER_NODES C
	JOIN REGIONS R ON C.REGION_ID = R.REGION_ID 
	GROUP BY 1,START_DATE,NODE_ID,END_DATE
	ORDER BY 1,5
)
SELECT 	  AVG(END_DATE - START_DATE )
FROM DATE_CTE
WHERE CURRENT_NODE <> NEXT_NODE AND EXTRACT ('YEAR' FROM END_DATE) <> '9999'


-- QUE 5 : What is the median, 80th and 95th percentile for this same reallocation days metric for each region?
-- ANS : 

WITH DATE_CTE AS (
	SELECT CUSTOMER_ID,REGION_NAME,NODE_ID CURRENT_NODE, 
	LEAD(NODE_ID) OVER(PARTITION BY CUSTOMER_ID ORDER BY START_DATE) NEXT_NODE,
	START_DATE, END_DATE
	FROM CUSTOMER_NODES C
	JOIN REGIONS R ON C.REGION_ID = R.REGION_ID 
	GROUP BY 1,START_DATE,NODE_ID,END_DATE,REGION_NAME
	ORDER BY 1,5
)
SELECT REGION_NAME,
PERCENTILE_CONT(0.5) WITHIN GROUP(ORDER BY END_DATE - START_DATE) AS "MEDIAN", -- query to find median, that is, calculate 50th percentile 
PERCENTILE_CONT(0.8) WITHIN GROUP(ORDER BY END_DATE - START_DATE) AS "80TH_PERCENTILE ",
PERCENTILE_CONT(0.95) WITHIN GROUP(ORDER BY END_DATE - START_DATE) AS "95TH_PERCENTILE"
FROM DATE_CTE
WHERE CURRENT_NODE <> NEXT_NODE AND EXTRACT ('YEAR' FROM END_DATE) <> '9999'
GROUP BY 1



